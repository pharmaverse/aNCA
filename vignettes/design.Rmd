---
title: "Design & Architecture"
description: >
    This document captures the high-level architecture, data flow, and key design decisions for the aNCA package and its embedded Shiny application.

output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design & Architecture}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

The design of the R package provides high-level functions based on the PKNCA package, allowing to convert a standard CDISC ADNCA file into a PKNCAdata object. Within this package, we use a Shiny environment, that simplifies for our non-programmer users this process by providing a user interface for every programmatic decision. Additionally, the App simplifies the exploration of outputs and the investigation of the data (Quality control, exclusion of records, filtering...).

## 1. Folder structure

This diagram represents the high-level architecture and data flow within the aNCA package and Shiny application.

```         
aNCA Shiny App Architecture
├── Main Components and Responsibilities
│   ├── R package Functions (`R/`)
│   │   ├── Core NCA helpers
│   │   └── Mapping and validation logic (`apply_mapping.R`)
│   │
│   ├── Shiny App (`inst/shiny/`)
│   │   ├── `app.R` (Main entry point for the app)
│   │   ├── UI Modules and Server Logic
│   │   │   ├── Module Files: `inst/shiny/modules/{tab_data, tab_explore, tab_nca, tab_tlg}.R/`
│   │   │   ├── Tab Data Subodules: `inst/shiny/modules/tab_data/`
│   │   │   ├── Tab Explore Submodules: `inst/shiny/modules/tab_explore/`
│   │   │   ├── Tab NCA Submodules: `inst/shiny/modules/tab_nca/`
│   │   │   └── Tab TLG Submodules: `inst/shiny/modules/tab_tlg/`
|   |   |
│   │   ├── Shiny end-to-end tests: `inst/shiny/tests/`
|   │   |
│   │   └── Session wiring: Connection logic for tabs and modules
│   │
│   ├── Documentation (`documentation/`)
│   │   ├── User Guide (website): `vignettes/`
│   │   ├── Static Documentation Site: `pkgdown/` configuration + `docs/`
│   │   ├── System Validation Files: `documentation/`
│   │   └── General Architecture Descriptions: `documentation/`
│   │
│   └──  Testing (`tests/`)
│       └── Unit Tests for `R/`: `tests/testthat/`
│
└── --- End of Architecture ---
```

## 2. Data flow

Answer these: - DataTab: Data upload (CSV, RDS, XPT, parquet) & preprocessing. Creation of PKNCAdata object (`pknca_data`) - NCATab: Modification of PKNCAdata object to apply all NCA settings (`processed_pknca_data`) and run calculations to obtain PKNCAresults object (`res_nca`) - TLG Tab: Generation of tables, listings, and graphs from `processed_pknca_data` (and at some point `res_nca`). Its standard Shiny input settings are specified in `inst/shiny/tlg.yaml` - Transformations applied (filters, mapping, unit handling, imputation rules, PKNCA object creation). - Where intermediate state is stored (typically `session$userData` in Shiny).


The high level picture of the App, which is shown in [App.R](../inst/shiny/app.R), can be summarized on a diagram where:

<img src="images/design/diagram_server.png" alt="Diagram of the App server"/>


For better details on the server lower level processing actions (order of functions in `\R`), check directly the [`.../R_script_template.R`]()

## 3. Session & state management

-   In `session$userData$results` we store all objects that are intended for the ZIP folder output (mappings, settings, units_table, ratios_table, etc.).
-   In `session$userData` we also store intermediate objects (e.g., `pknca_data`, `processed_data`, etc.) that are used across tabs.

## 4. See also...

-   [Roadmap with the next year goals](./roadmap.md) - Indicating the objectives planned to be achieved.
-   [Validation Plan and Coverage](../vignettes/validations.Rmd) - Describing the validation strategy implemented and the ideas for the future.
-   [governance.md](./governance.md) - Describing the project's management style.
