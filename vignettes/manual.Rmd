---
title: "aNCA Manual"
description: >
  User guide and technical reference for aNCA: data, workflow, settings, and outputs.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{aNCA Manual: Technical Reference}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```



# Table of Contents

| Section | Link |
|---|---|
| 1. Overview | [Overview](#1-overview) |
| 2. Data Requirements | [Data Requirements](#2-data-requirements) |
| 3. Data Preparation | [Data Preparation](#3-data-preparation) |
| 4. Running NCA | [Running NCA](#4-running-nca) |
| 5. NCA Settings | [NCA Settings](#5-nca-settings) |
| 6. Results & Outputs | [Results & Outputs](#6-results--outputs) |
| 7. TLG | [TLG](#7-tlg) |
| 8. Customization | [Customization](#8-customization) |
| 9. Technical Architecture | [Technical Architecture](#9-technical-architecture) |
| 10. Troubleshooting & FAQ | [Troubleshooting & FAQ](#10-troubleshooting--faq) |
| 11. References & Resources | [References & Resources](#11-references--resources) |
| Glossary | [Glossary](#glossary) |

# 1. Overview

This manual is a user guide and technical reference on how aNCA operates internally. It covers data requirements, workflow, settings and output definitions.

For a quick start and installation instructions, see [Get Started](aNCA.html). For NCA concepts, see [What is NCA?](background.html).

---

# 2. Data Requirements

## Required Columns

| Variable | Label | Description | CDISC Reference |
|----------|-------|-------------|-----------------|
| `STUDYID` \* | Study Identifier | Character column to identify the study | CDISC Standard |
| `USUBJID` \* | Unique Subject Identifier | Character/numeric column to identify a subject across studies | CDISC Standard |
| `ATPTREF` \* | Analysis Timepoint Reference | Can be any column, used to filter data for NCA calculations (e.g., visit, dose number) | CDISC ADNCA |



The sample identifiers help define what records are used for NCA calculations. At minimum, you need a parameter (PARAM), specimen type (PCSPEC), and concentration value (AVAL).
- The specimen type (PCSPEC) is used to differentiate between different sample matrices (e.g., plasma vs urine) and allows for separate NCA excretion calculations for urine if needed.
- The parameter (PARAM) is used to identify the analyte being measured and allows for multi-analyte assays to be processed in the same dataset.
- Both generally together also help specifying the correct unit (AVALU) for the concentration values (AVAL).

| Variable | Label | Description | CDISC Reference |
|----------|-------|-------------|-----------------|
| `PARAM` \* | Parameter | Name of the measured analyte | CDISC Standard |
| `PCSPEC` \* | Specimen Material Type | Sample matrix (PLASMA, SERUM, URINE, etc.) | C78734 |
| `AVAL` \* | Analysis Value | Numeric analyte concentration (BLQ values assumed to be 0 if not imputed) | CDISC Standard |

### Additional Optional Variables

- |AEFRLT-AFRLT| is useful for the PK excretion parameters that need to consider the duration of sample collection to calculate rates or total amounts.
- |ADOSEDUR| is used to determine the appropriate start imputation for missing C₀ values in intravascular doses (IV). The automatic half-life determined by PKNCA may also change based on the duration of the infusion for superior accuracy. If not provided, aNCA assumes all doses are bolus (`ADOSEDUR = 0`) and applies the corresponding imputation rules.
- `VOLUME` is used for excretion studies to calculate the total amount excreted in urine or feces. It can also be used to calculate the excretion rate if the sample collection duration is provided (via `AEFRLT`).
- `WTBL` is used for excretion studies to calculate dose-normalized parameters based on body weight.
- `TRTRINT` is the common known as Tau (τ) used for the last dose of a subject/treatment (e.g., `start + TRTRINT`). If not provided, aNCA will guess the dosing interval based on the exact actual dose times, applying uneven intervals if necessary.
- `METABFL` is used to flag records that represent metabolites. This allows users to easily identify and analyze metabolite data separately from parent drug data to compute metabolite-ratio operations. Additionally, it will also be considered for the start imputation rules, where metabolites will be imputed to `C0 = 0` for first doses regardless of the route of administration or the availability of dose duration information.

| Variable | Label | Description | Use Case |
|----------|-------|-------------|----------|
| `AEFRLT` | Actual Relative End Time from First Dose | End time of sample collection | Urine/feces samples |
| `ADOSEDUR` | Actual Duration of Treatment Dose | Dose infusion duration | IV infusions |
| `VOLUME` | Volume Value | Collected sample volume | Excretion studies |
| `VOLUMEU` | Volume Value Unit | Unit of VOLUME | Excretion studies |
| `WTBL` | Weight at Baseline | Subject's weight | Excretion studies |
| `WTBLU` | Weight at Baseline Unit | Unit of WTBL | Excretion studies |
| `TRTRINT` | Planned Treatment Interval | Time between doses (τ) in multiple dose studies | Multiple dosing |
| `METABFL` | Metabolite Flag | "Y" if PARAM is a metabolite | Multi-analyte assays |


## Data Format Example

The dose variables describe the treatment administration information necessary for NCA calculations.

- `DOSETRT` help us identify different treatments even if they happen within the same subject.
- `ROUTE` is used to derive the PKNCA route variable (intravascular, extravascular). This, together with the dose duration (`ADOSEDUR`), helps determine the appropriate start imputations for missing C₀ values.
- `DOSEA` is used for dose normalization of parameters like Cmax and AUC if the user selects that option or the `...DN` parameters, apart from other parameters that are always dose-normalized (e.g., clearance).

| Variable | Label | Description | CDISC Reference |
|----------|-------|-------------|-----------------|
| `DOSETRT` \* | Name of Treatment | Protocol-specified study treatment | CDISC Standard |
| `ROUTE` \* | Route of Administration | Either "intravascular" or "extravascular" (or specific routes) | C66729 |
| `DOSEA` \* | Actual Treatment Dose | Actual dose amount given | CDISC Standard |


---

# 3. Data Preparation

Data preparation involves mapping your raw dataset to the ADNCA format, handling column naming and units, and setting up exclusion rules before NCA analysis.

## Column Mapping

Column mapping translates your raw dataset into ADNCA format. This is done via the UI mapping interface or the `apply_mapping()` function.

**Key Operations**:
- Rename columns to match ADNCA standards (e.g., "CONCENTRATION" → `AVAL`)
- Create default values for unmapped required variables (e.g., `ADOSEDUR = 0` if not provided)
- Apply CDISC variable labels and formatting
- Remove duplicate concentration records
- Handle special cases:
  - If `DOSETRT` not mapped, sets `DOSETRT = PARAM`
  - If `ADOSEDUR` not mapped, sets all values to 0


## Time Variables

Time variables relate dose administrations to sample collection times. These are essential for proper interval calculations in NCA.

| Variable | Label | Description |
|----------|-------|-------------|
| `AFRLT` \* | Actual Relative Time from Analyte First Dose | Actual time since first dose |
| `ARRLT` \* | Actual Relative Time from Reference Dose | Actual time since last dose |
| `NFRLT` \* | Nominal Relative Time from Analyte First Dose | Planned time since first dose |
| `NRRLT` \* | Nominal Relative Time from Reference Dose | Planned time since last dose |

## Units

Units are essential for parameter calculations and reporting. All unit columns must be present and consistent.

| Variable | Label | Description |
|----------|-------|-------------|
| `AVALU` \* | Analysis Value Unit | Unit of AVAL (e.g., "ng/mL", "µg/mL") |
| `RRLTU` \* | Relative Time Unit | Unit of time variables (e.g., "hr", "day") |
| `DOSEU` \* | Dose Units | Unit of DOSEA (e.g., "mg", "mg/kg") |

## Record Exclusions (NCAwXRS)

The `NCAwXRS` columns are used to **exclude specific records from NCA calculations** at the data preparation stage.

**Column Name Pattern**: `NCA1XRS`, `NCA2XRS`, ..., `NCA30XRS`

**Purpose**: Character columns that explain why a record should not be included in PK NCA calculations.

**Effects on NCA Computation**:
- Records with **any non-empty value** in NCAwXRS columns are automatically excluded from all PK calculations
- Exclusion reasons are concatenated and stored in the internal `nca_exclude` column
- Excluded records are retained in outputs but marked as excluded
- Multiple exclusion columns allow different reasons to be tracked separately

**Example**:
```r
ADNCA$NCA1XRS <- ifelse(ADNCA$AVAL > 10000, "Concentration too high", "")
ADNCA$NCA2XRS <- ifelse(ADNCA$ARRLT < 0, "Negative time point", "")
```

For implementation details, see [Technical Architecture > Data Preparation](#data-preparation-functions).

---

# 4. Running NCA

The NCA workflow consists of five main steps executed through the aNCA interface.

## Step-by-Step Workflow

1. **Upload & Map Data**: Load your dataset and map columns to ADNCA format using the Data tab
2. **Configure Settings**: Choose imputation methods, BLQ handling, and AUC calculation in the NCA Setup tab
3. **Review Intervals**: Verify dose times and intervals are correctly identified
4. **Run Analysis**: Click "Run NCA" to execute PKNCA calculations
5. **Generate Outputs**: Create TLG outputs and download results in the Outputs tab

## Main Functions Used

The workflow is orchestrated internally by:

- **Data Preparation**: `apply_mapping()`, `format_pkncaconc_data()`, `format_pkncadose_data()`
- **Interval Creation**: `format_pkncadata_intervals()`, `update_main_intervals()`
- **NCA Execution**: PKNCA's `PKNCAdata()` and `pk.nca()`
- **Output Generation**: `export_cdisc()` for CDISC datasets, TLG generation functions

For detailed technical information, see [Technical Architecture](#9-technical-architecture).

---

# 5. NCA Settings

NCA settings control how PKNCA processes your data during calculations. These are configured in the NCA Setup tab.


## Start concentration Imputation Rules

Imputation rules specify how to handle missing or implied start concentrations (C₀). Selection depends on:
- Dose route (IV vs extravascular)
- Dose duration (bolus vs infusion)
- Anylyte type (parent drug vs metabolite)
- Data availability (e.g., concentration at dose avaialble, pre-dose concentrations...)

**Common Rules**:
- **First dose, non-IV bolus**: C₀ = 0
- **First dose, metabolite**: C₀ = 0 (regardless of route)
- **Later dose, non-IV**: C₀ = pre-dose concentration
- **IV bolus, parent drug**: C₀ = back-extrapolated via log-linear regression (if possible)

For detailed imputation logic, see [Technical Architecture > Data Imputation Rules](#data-imputation-rules).

## BLQ (Below Limit of Quantification) Handling

BLQ values are handled using position-based or Tmax-based strategies.

**Position-based Options**:
- `first`: Strategy for BLQ at profile start
- `middle`: Strategy for BLQ in profile middle
- `last`: Strategy for BLQ at profile end

**For each position, you can choose**:
- **Numeric value** (e.g., `0`, `LOQ/2`): Substitute BLQ with this value
- `"drop"`: Exclude from calculations
- `"keep"`: Treat as 0

## AUC Calculation Methods

aNCA supports multiple AUC calculation methods via PKNCA. These methods control how the area under the concentration-time curve is calculated.

### Integration Methods (Between Concentrations)

aNCA supports three methods for interpolating AUC between two concentration measurements:

| Method | Interpolation Rules | Best For |
|--------|-------------------|----------|
| **Linear-up/log-down** (default) | Linear for rising, logarithmic for declining concentrations | Standard/exogenous substances with first-order elimination |
| **Linear** | Linear trapezoidal rule for all segments | Endogenous substances or non-first-order elimination |
| **Lin-log** | Linear before Tmax, logarithmic after Tmax | Infrequently used; specific modeling scenarios |

**Details**:
- **Linear-up/log-down**: Most commonly used in PK. Applies linear interpolation when concentrations increase or when either concentration is zero; uses log interpolation for declining concentrations.
- **Linear**: Simplest method; uses linear trapezoidal rule throughout. Good for situations where first-order kinetics may not apply.
- **Lin-log**: Uses linear interpolation before Tmax, logarithmic interpolation after Tmax.

### Extrapolation Methods (After Last Measurement)

After the last measurable concentration (Tlast), AUC can be extrapolated using different approaches:

| Method | Description | Use Case |
|--------|-------------|----------|
| **AUClast** | No extrapolation; extrapolated AUC = 0 | When full profile to negligible concentrations is available |
| **AUCall** | Linear triangle from Tlast to zero | When Tlast is not the final measurement; interpolates missing data |
| **AUCinf** | Extrapolates to infinity using: Clast/λz | When terminal elimination is well-characterized; common for regulatory submissions |

**Important Note**: 
- `aucinf.obs` uses **observed** Clast (last measured concentration)
- `aucinf.pred` uses **predicted** Clast (extrapolated via regression)
- High extrapolation percentage (>20%) may indicate poor terminal phase characterization

### AUC Types Available

| Parameter | Description | Extrapolation | Formula |
|-----------|-------------|---------------|---------|
| `auclast` | AUC to last measurable concentration | None | Sum of trapezoids to Tlast |
| `aucall` | AUC to infinity with linear extrapolation | Linear triangle | AUClast + triangle(Tlast→0) |
| `aucinf.obs` | AUC to infinity (observed Clast) | Using Clast directly | AUClast + Clast/λz |
| `aucinf.pred` | AUC to infinity (predicted Clast) | Using regression fit | AUClast + Ĉlast/λz |
| `aucint` | Partial AUC over specified interval | User-defined | AUC(time1, time2) |

---

# 6. Results & Outputs

All output files can be downloaded after running NCA. The export button is located in the top-right of the Outputs tab.

## Output Structure

The output package includes:

### Exploration Outputs
- **Individual plots**: Subject-level concentration-time profiles
- **Mean plots**: Mean ± SD/SE by treatment group

### NCA Results
- **nca_results**: Pivoted PKNCA results for all calculated parameters with units

### CDISC Datasets
- **PP**: Pharmacokinetic Parameters (standard CDISC/SDTMIG format)
- **ADPP**: Analysis Dataset for PK Parameters (ADaM format)
- **ADNCA**: Input data (adapted to user selections with standardizations)

### Additional Analysis
- **Matrix/specimen ratios**: Metabolite/parent ratios or cross-matrix comparisons
- **Excretion results**: Urine/feces data if applicable

### Extras
- **R script**: Reproduces entire analysis starting from raw data
- **Settings file**: Defines analysis specifications (can be re-uploaded to re-run)
- **Results slides**: Presentation deck with Exploration outputs and parameter summaries

## Output Formats
- **Graphics and plots**: PNG or HTML
- **Data tables**: CSV, XPT, or RDS
- **Slide decks**: PPTX or QMD (renderable to HTML/PDF)

---

# 7. TLG (Tables, Listings, and Graphs)

aNCA generates regulatory-ready TLG outputs for reporting and analysis.

## Available Tables

- **Summary Statistics Tables**: Descriptive stats by treatment (mean, SD, CV%, median, min, max, geometric mean)
- **NCA Parameter Tables**: All calculated parameters with dosing and demographic info
- **Excretion Tables**: Urine/feces-specific parameters
- **Ratio Tables**: Metabolite/parent ratios and cross-matrix comparisons
- **Flagged Results Tables**: Parameters flagged for data quality or scientific concerns

## Listings

- **Individual Parameters**: One row per subject per analyte with all NCA parameters


## Graphs
- **Individual Concentration-Time Plots**: Subject profiles (linear and semi-log scales)
- **Mean/Median Plots**: Mean ± SD or SE by treatment with confidence intervals
- **Half-Life Plots**: Terminal slope visualization with selected points highlighted

For TLG customization details, see [Customization](#8-customization) section.

---

# 8. Customization

aNCA allows customization of labels, titles, grouping variables, and statistical summaries throughout outputs.

## Changing Labels and Titles

- **Study Identifiers**: Customize study labels on plots and reports
- **Parameter Labels**: Rename analytes for clarity (e.g., "Parent Drug" vs "Drug A")
- **Treatment Labels**: Display alternative treatment names in outputs
- **Plot Titles & Footnotes**: Add custom titles, footnotes, and annotations
- **Axis Labels**: Use template syntax:
  - `!COLUMN`: Inserts column label
  - `$COLUMN`: Inserts column value (e.g., STUDYID)

## Grouping and Statistics

- **Grouping Variables**: Select columns to group by in summary tables (treatment, dose level, etc.)
- **Statistical Options**: Choose statistics to calculate and display:
  - Descriptive stats: mean, SD, CV%, median, min, max, geometric mean
  - Sample sizes and missing counts
  - Dose-normalized parameters
- **Analysis Flags**: Include/exclude parameters based on quality flags
- **Subgroup Analysis**: Stratify results by demographics or study cohort

---

# 9. Technical Architecture

This section provides technical details on how aNCA processes data internally. Understanding these functions helps trace data transformation from input to output.

## Data Preparation Functions {#data-preparation-functions}

### Column Mapping: `apply_mapping()`

**File**: `R/apply_mapping.R`

**Purpose**: Transforms user dataset to ADNCA format

**Operations**:

- Renames columns based on user-specified mappings
- Creates new columns for unmapped required variables (e.g., `ADOSEDUR = 0` if not mapped)
- Handles special cases:
  - If `DOSETRT` not mapped, sets `DOSETRT = PARAM`
  - If `ADOSEDUR` not mapped, sets all values to 0
- Removes concentration duplicates based on key identifiers
- Applies CDISC variable labels

**Example**:

```r
# User maps their column "CONCENTRATION" to AVAL
new_dataset <- apply_mapping(
  dataset = user_data,
  mapping = list(AVAL = "CONCENTRATION", ...),
  desired_order = c("STUDYID", "USUBJID", ...)
)
```

### Concentration Data Formatting: `format_pkncaconc_data()`

**File**: `R/format_data.R`

**Purpose**: Creates PKNCA-compatible concentration dataset

**Operations**:

- Filters out dosing records (EVID = 0, PARAMCD not containing "DOSE")
- Creates `DOSNOA`: Sequential dose number within each group
- Standardizes route to PKNCA format:
  - "intravascular" (IV)
  - "extravascular" (EV, oral, etc.)
- Creates `CONCDUR`: Sampling duration (if end time provided)
- Merges NCAwXRS exclusion reasons into `nca_exclude` column
- Initializes half-life selection flags

**Example**:

```r
conc_data <- format_pkncaconc_data(
  ADNCA = adnca_data,
  group_columns = c("STUDYID", "DOSETRT", "USUBJID", "PARAM"),
  time_column = "AFRLT",
  rrlt_column = "ARRLT",
  route_column = "ROUTE",
  nca_exclude_reason_columns = c("NCA1XRS", "NCA2XRS")
)
```

### 3. Dose Data Formatting: `format_pkncadose_data()`

**File**: `R/format_data.R`

**Purpose**: Extracts and formats dosing information

**Operations**:

- Creates dose records from concentration data
- Calculates `DOSNOA`: Sequential dose numbers based on time
- Extracts route, duration, and dose amount
- Links dose times to concentration profiles

### Interval Creation: `format_pkncadata_intervals()`

**File**: `R/intervals.R`

**Purpose**: Defines time intervals for NCA calculations

**Operations**:

- Creates intervals based on dose times
- Determines start and end times for each interval:
  - **Single dose**: End time = Inf (or last measurable time)
  - **Multiple dose**: End time = next dose time or `start + TRTRINT`
- Assigns PKNCA parameters to intervals
- Supports partial AUC calculations

**Interval Logic**:

```
Dose 1: [0, next_dose_time or Inf]
Dose 2: [dose_time_2, next_dose_time or Inf]
...
```

### Parameter Assignment: `update_main_intervals()`

**File**: `R/intervals.R`

**Purpose**: Updates intervals with user-selected parameters

**Operations**:

- Assigns parameters based on study type (single/multiple dose, IV/EV)
- Adds partial AUC intervals
- Implements BLQ imputation rules
- Creates start concentration imputation strategies

## Data Imputation Rules {#data-imputation-rules}

The imputation actions are specified exclusively for parameters that are not exclusively calculated based on observed concentrations (e.g., Cmax, Tmax, AUClast, etc.) but also for parameters that require extrapolation to infinity (e.g., AUCinf) or parameters that are calculated based on the terminal slope (e.g., half-life, clearance, volume). The imputation rules are applied during the interval creation step in `update_main_intervals()`, where the appropriate imputation method is selected based on the characteristics of each record (e.g., dose route, dose duration, metabolite status, etc.) and the availability of data (e.g., presence of pre-dose concentrations, presence of multiple post-dose concentrations for log-linear regression).
They are specified in the `PKNCAdata` object via the `impute` column. The order of imputation is as follows:

**Order of Application**: `start_concentration` > `BLQ imputation`


### Start Concentration Imputation: `create_start_impute()`

**File**: `R/create_start_impute.R`

**Purpose**: Defines how to handle missing or implied start concentrations (C₀)

**Rules**:

| Condition | Imputation Method | Description |
|-----------|------------------|-------------|
| C₀ measured | `NA` | No imputation needed |
| 1st dose, not IV bolus | `start_conc0` | C₀ = 0 |
| 1st dose, metabolite | `start_conc0` | C₀ = 0 |
| Later dose, not IV bolus | `start_predose` | C₀ = pre-dose concentration |
| Later dose, metabolite | `start_predose` | C₀ = pre-dose concentration |
| IV bolus, parent drug, logslope possible | `start_logslope` | Back-extrapolate using log-linear regression |
| IV bolus, parent drug, logslope not possible | `start_c1` | Use first measured concentration |

**PKNCA Method**: `pk.calc.c0()` from PKNCA package

### BLQ (Below Limit of Quantification) Imputation

**Implementation**: Via `blq_imputation_rule` parameter in `update_main_intervals()`

**Supported Strategies**:

1. **Position-based** (PKNCA default):
   - `first`: How to handle BLQ at start of profile
   - `middle`: How to handle BLQ in middle of profile
   - `last`: How to handle BLQ at end of profile

2. **Tmax-based**:
   - `before.tmax`: BLQ before maximum concentration
   - `after.tmax`: BLQ after maximum concentration

**Options for each position**:

- **Numeric value** (e.g., `0`, `LOQ/2`): Substitute BLQ with this value
- `"drop"`: Exclude the BLQ value from calculations
- `"keep"`: Use BLQ as 0

**Example**:

```r
blq_rule <- list(
  first = "0",        # Set first BLQ to 0
  middle = "drop",    # Drop middle BLQ values
  last = "keep"       # Keep last BLQ as 0
)
```


## AUC Calculation Methods

aNCA uses PKNCA's AUC calculation methods. Users can select the calculation method in settings.


| Method | Description | PKNCA Function | When to Use |
|--------|-------------|----------------|-------------|
| Linear | Linear trapezoidal rule | `pk.calc.auc.last(..., method="linear")` | Standard method for most data |
| Linear-up/log-down | Linear on rising, log on falling | `pk.calc.auc.last(..., method="lin up/log down")` | Common in PK analysis |
| Log | Logarithmic trapezoidal | `pk.calc.auc.last(..., method="log")` | For log-linear elimination |

**Reference**: [PKNCA AUC Methods](https://billdenney.github.io/pknca/reference/pk.calc.auc.html)

### AUC Types

| Parameter | Description | PKNCA Function | Formula |
|-----------|-------------|----------------|---------|
| `auclast` | AUC to last measurable concentration | `pk.calc.auclast()` | Sum of trapezoids |
| `aucinf.obs` | AUC to infinity (observed Clast) | `pk.calc.aucinf.obs()` | AUClast + Clast/λz |
| `aucinf.pred` | AUC to infinity (predicted Clast) | `pk.calc.aucinf.pred()` | AUClast + Ĉlast/λz |
| `aucint` | Partial AUC over interval | `pk.calc.aucint()` | AUC(start, end) |

**Reference**: [PKNCA Parameter Functions](https://billdenney.github.io/pknca/reference/index.html#pk-parameters)

## Flag Rules

aNCA results will be flagged based on predefined scientific rules to help users identify potential issues with the data or calculations. These flags are generated based on the calculated parameters and the underlying data quality. There are two types:

- Half-life selection criteria flags (r.squared, span ratio, adjusted R²). Any half-life or half-life dependent parameter (e.g., AUCinf) may be flagged if the half-life selection does not meet the criteria. Other flags may be based on general data quality issues (e.g., BLQ values, missing data, etc.) that can affect any parameter.
- AUC selection criteria flags (AUC percentage extrapolated observed, AUC percentage extrapolated predicted). When the extrapolated percentage exceeds a certain threshold (e.g., 20%), it may indicate that the terminal phase is not well characterized. Any AUC-extrapolated (e.g., AUCinf) or AUC-extrapolated derived parameter (e.g., clearance, volume) may be flagged if the AUC extrapolation percentage exceeds the threshold.


**Common Flags**:

- **Half-life flags**: 
  - `r.squared (R2) < 0.9`: Poor fit of terminal slope
  - `adj.r.squared < 0.8`: Poor adjusted fit of terminal slope (R²)
  - `span.ratio < 2`: Insufficient span of half-life

- **AUC flags**:
  - `auc_extrap_pct_obs (AUCPEO) > 20%`: High extrapolation based on observed
  - `auc_extrap_pct_pred (AUCPEP) > 20%`: High extrapolation based on predicted

**Implementation**: Controlled by PKNCA's built-in rules

---

# Half-Life Selection and Slope Selector

## Automated Half-Life Calculation

By default, PKNCA automatically selects the terminal elimination phase using the following algorithm:

1. Omit all missing and BLQ concentrations. If the administration is an infusion, also omit all points during the infusion.
2. Estimate the half-life for each set of points from the first concentration measure after Tmax to the third measure before Tlast.
3. Select the best half-life expecting that:
- The adjusted r-squared must be within a tolerance factor (typically 0.0001) of the largest adjusted r-squared.
- The λz value (slope for the half-life line) must be positive; in other words, the half-life slope must be decreasing.
- If multiple choices of points fit the above criteria, choose the one with the most concentration measurements included.


**Reference**: [PKNCA Half-Life Calculation](https://billdenney.github.io/pknca/articles/Half-life.html)

## Manual Slope Selection

Users can override automatic selection using the **Slope Selector** tab in the NCA Setup.

### Inclusion (Manual Slope Selection)

**Purpose**: Specify exactly which points to use for half-life calculation

**Method**:

- **Via UI**: Click first and last points to include
- **Via Table**: Enter subject, analyte, and RANGE (point indices)

**Effect**:

- Overrides PKNCA's automatic selection
- Uses only the specified points for half-life regression
- Requires at least 3 points

**Implementation**:

- Sets `is.included.hl = TRUE` for selected points
- Uses PKNCA's `include_half.life` column
- Function: PKNCA uses `PKNCAconc(..., include_half.life="include_half.life")`

### Exclusion (Point Removal)

**Purpose**: Remove outlier points from half-life calculation

**Method**:

- **Via UI**: Double-click points to exclude
- **Via Table**: Enter subject, analyte, and RANGE

**Effect**:

- Removes specified points from half-life calculation
- PKNCA recalculates using remaining points
- Can exclude multiple points

**Implementation**:

- Sets `is.excluded.hl = TRUE` for excluded points
- Uses PKNCA's `exclude_half.life` column
- Function: PKNCA uses `PKNCAconc(..., exclude_half.life="exclude_half.life")`

### Viewing Selections

Results are shown in:

- **Slopes Information** tab: Shows automatic and manual slope selections
- **Manual Adjustments** tab: Lists user-made changes
- **Slope plots**: Visual display of selected points

---

# General Exclusions

General exclusions remove entire records from NCA calculations (not just half-life).

### Pre-mapped Exclusions (NCAwXRS)

- Defined in input data via NCAwXRS columns
- Applied during data import
- Cannot be modified in the app

### In-App Exclusions


- Added via slope selector "Exclusion" option
- Applied to entire concentration records
- Reasons documented in results

**Implementation**: Both types use PKNCA's `exclude` column in PKNCAconc object

**Effect**:

- Excluded records are skipped in all NCA calculations
- Parameters are not calculated for excluded data
- Exclusions are documented in output datasets

## Dataset Derivation

## PP (Pharmacokinetic Parameters)

**Definition**: Standard CDISC dataset containing calculated NCA parameters

**Derivation Steps** (in `export_cdisc()`):

1. Extract NCA results from PKNCA
2. Translate PKNCA parameter names to CDISC terms (`PPTESTCD`, `PPTEST`)
3. Reshape from long to wide format (one row per subject-analyte-interval)
4. Add metadata from concentration and dose data (see the metadata information [here](../data-raw/metadata_nca_parameters.csv))
5. Apply CDISC variable labels and attributes

**Key Columns**:

- `STUDYID`, `USUBJID`: Identifiers
- `PPTESTCD`: Parameter code (e.g., "AUCLST", "CMAX", "TMAX")
- `PPTEST`: Parameter name (e.g., "AUC to Last Nonzero Conc")
- `PPSTRESN`: Numeric result
- `PPSTRESU`: Unit of result
- `PPSPEC`: Specimen type

**Reference**: CDISC SDTMIG PP Domain

## ADPP (Analysis Dataset for Pharmacokinetic Parameters)

**Definition**: Analysis-ready version of PP with additional analysis variables

**Derivation Steps**:

1. Start with PP dataset
2. Add analysis flags (e.g., `ANLFL`, `ANL01FL`)
3. Add grouping variables from ADNCA
4. Add treatment and demographic variables
5. Add derived variables (e.g., `AVAL = PPSTRESN`)
6. Apply CDISC ADaM standards

**Key Additional Columns**:

- `PARAM`: Parameter description
- `PARAMCD`: Parameter code
- `AVAL`: Analysis value (copy of PPSTRESN)
- `AVALU`: Analysis unit
- Treatment variables: `TRT01A`, `TRT01P`
- Demographic variables: `AGE`, `SEX`, `RACE`

**Reference**: CDISC ADaMIG ADPP

## ADNCA (Maintained in Output)

**Definition**: The input dataset, potentially with additional derived columns

**Derivation**:

- ADNCA is the primary input to aNCA
- Minimal modifications are made (standardized route, dose numbers)
- Excluded records are retained but marked

**Purpose**:

- Traceability between input and output
- Provides concentration-time data for plotting
- Supports re-analysis and validation

**Function**: Handled by `PKNCA_create_data_object()` and data formatting functions

---

# TLG (Tables, Listings, and Graphs) Creation

## TLG Framework

aNCA generates regulatory-ready TLGs using the following packages:

- **Tables**: `{tern}`, `{rtables}`, `{formatters}`
- **Listings**: `{rlistings}`
- **Graphs**: `{ggplot2}`, `{plotly}`

## Available TLGs

### Tables

1. **Summary Statistics Tables** (`t_pksummary01`)
   - Descriptive statistics by treatment group
   - Mean, SD, CV%, median, min, max, geometric mean
   - Customizable statistics and grouping variables

2. **Concentration-Time Listings** (`l_pkcl01`)
   - Individual subject concentration data
   - Time points and measured values
   - Flags for BLQ and exclusions

3. **Parameter Summary Tables**
   - NCA parameters by treatment
   - Statistical comparisons
   - Dose-normalized parameters

### Listings

1. **Individual Parameters** (`l_pkpl01`)
   - One row per subject per parameter
   - All calculated NCA parameters
   - Flags and exclusion reasons

2. **Concentration Data**
   - Time-concentration profiles
   - Sample collection details
   - Quality flags

### Graphs

1. **Individual Plots** (`g_lineplot`)
   - Subject-level concentration-time profiles
   - Linear and semi-log scales
   - Dose markers

2. **Mean Plots** (`g_pkcg`)
   - Mean ± SD or SE
   - By treatment group
   - Confidence intervals

3. **Half-Life Plots** (`get_halflife_plots`)
   - Terminal slope visualization
   - Selected points highlighted
   - R² and half-life values

## TLG Customization

Users can customize TLGs using widgets in the TLG tab:

- **Titles and Footnotes**: Free text input
- **Axis Labels**: Customizable with special syntax:
  - `!COLUMN` references column label
  - `$COLUMN` references column value
- **Grouping Variables**: Select from available columns
- **Statistical Options**: Choose statistics to display

**Example**:

```
X-axis label: Time (!RRLTU)
# Expands to: Time (hr) if RRLTU = "hr"
Title: Study $STUDYID - !PARAM Analysis
# Expands to: Study STUDY001 - Drug X Analysis
```

## TLG Generation Process

1. **Order Details**: User selects desired TLGs
2. **Parameter Selection**: For each TLG, specify options
3. **Generation**: TLGs created using appropriate functions
4. **Export**: Download as PDF, Word, or PowerPoint

**Implementation**:

- TLG templates defined in `inst/shiny/tlg_definitions/`
- Generation functions in `R/` (e.g., `g_pkcg.R`, `l_pkcl01.R`)
- Export handled by `{officer}` and `{flextable}`

---

# Key PKNCA Functions and Methods

aNCA builds on PKNCA for core NCA calculations. Understanding PKNCA methods helps interpret results.

## Data Object Creation

| Function | Purpose | aNCA Wrapper |
|----------|---------|--------------|
| `PKNCA::PKNCAconc()` | Creates concentration object | `PKNCA_create_data_object()` |
| `PKNCA::PKNCAdose()` | Creates dose object | `PKNCA_create_data_object()` |
| `PKNCA::PKNCAdata()` | Combines conc + dose + intervals | `PKNCA_create_data_object()` |

## NCA Calculations

| Function | Parameter | aNCA Usage |
|----------|-----------|------------|
| `pk.calc.cmax()` | Maximum concentration | Automatic |
| `pk.calc.tmax()` | Time of maximum | Automatic |
| `pk.calc.auclast()` | AUC to last | Automatic |
| `pk.calc.aucinf.obs()` | AUC to infinity | Automatic |
| `pk.calc.half.life()` | Terminal half-life | Automatic + manual |
| `pk.calc.cl.obs()` | Clearance | Automatic |
| `pk.calc.vz.obs()` | Volume of distribution | Automatic |

**Reference**: [PKNCA Function Reference](https://billdenney.github.io/pknca/reference/index.html)

## NCA Execution

```r
# Simplified workflow
pknca_data <- PKNCAdata(conc, dose, intervals)
results <- pk.nca(pknca_data)
```

**aNCA Wrapper**: The NCA workflow is encapsulated in the app's "Run NCA" button, which internally calls `pk.nca()` with configured settings.

---

# 10. Troubleshooting & FAQ

## Common Issues

### Issue: "No intervals for data" error

**Cause**: No valid NCA intervals were created from the dose and concentration data.

**Solutions**:
- Verify dose times are present in the data
- Check that time variables (`AFRLT`, `ARRLT`) are properly mapped and numeric
- Ensure at least some concentrations fall within expected intervals
- Review dose-timepoint relationships for logical errors

### Issue: "Too few points for half-life"

**Cause**: Insufficient concentration measurements to calculate terminal slope.

**Solutions**:
- Increase number of concentration samples post-Tmax
- Ensure adequate sampling in terminal phase (final 25% of profile)
- Check BLQ handling - missing early concentrations may affect calculations
- Consider manual slope selection if automatic selection fails

### Issue: Half-life dependent parameters flagged

**Cause**: Terminal slope calculation doesn't meet quality criteria (r² < 0.9, span ratio < 2, etc.).

**Solutions**:
- Use manual slope selection to override automatic selection
- Review raw data for outliers or data quality issues
- Consider alternative AUC methods that don't depend on half-life extrapolation
- Check if BLQ handling is appropriate

### Issue: High AUC extrapolation percentage

**Cause**: Large portion of AUC from extrapolation beyond measured data.

**Solutions**:
- Extend follow-up sampling period if possible
- Use observed Clast method instead of predicted
- Review whether extrapolation assumption is valid
- Consider flagging parameters if extrapolation exceeds acceptable thresholds

## Where to Get Help

- **GitHub Issues**: Report bugs or request features at https://github.com/pharmaverse/aNCA/issues
- **Documentation**: See the [Get Started guide](aNCA.html) and [Background](background.html) vignette
- **Community**: Join the Pharmaverse community for discussions

---

# 11. References & Resources

## PKNCA Documentation

- **Main Site**: https://billdenney.github.io/pknca/
- **Half-Life Selection**: https://billdenney.github.io/pknca/articles/Half-life.html
- **AUC Calculations**: https://billdenney.github.io/pknca/reference/pk.calc.auc.html
- **Parameter Reference**: https://billdenney.github.io/pknca/reference/index.html#pk-parameters

## CDISC Standards

- **SDTMIG**: Study Data Tabulation Model Implementation Guide
- **ADAMIG-ADNCA**: Analysis Data Model Implementation Guide
- **ADNCA**: https://www.cdisc.org/standards/foundational/adam

## Further Reading

- Denney, W. S., Duvvuri, S., & Buckeridge, C. (2015). Simple, Automatic Noncompartmental Analysis: The PKNCA R Package. *Journal of Pharmacokinetics and Pharmacodynamics*, 42(1), 11-17. https://doi.org/10.1007/s10928-015-9432-2

---


---

# Glossary

| Term | Definition |
|------|------------|
| **ADNCA** | Analysis Dataset for Non-Compartmental Analysis (CDISC format) |
| **ADPP** | Analysis Dataset for Pharmacokinetic Parameters |
| **AUC** | Area Under the Curve - measure of drug exposure |
| **BLQ** | Below Limit of Quantification |
| **CDISC** | Clinical Data Interchange Standards Consortium |
| **Cmax** | Maximum observed concentration |
| **Half-life (t½)** | Time for concentration to decrease by 50% |
| **NCA** | Non-Compartmental Analysis |
| **PKNCA** | R package for pharmacokinetic non-compartmental analysis |
| **PP** | Pharmacokinetic Parameters domain |
| **TLG** | Tables, Listings, and Graphs |
| **Tmax** | Time of maximum concentration |
| **λz** | Terminal elimination rate constant |

---

*For questions or issues, please visit the [GitHub repository](https://github.com/pharmaverse/aNCA/issues) or consult the [FAQ page](FAQs.html).*