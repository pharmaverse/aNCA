test_that("format_pkncaconc_data generates correct dataset", {
  # Generate sample ADNCA data
  ADNCA <- data.frame(
    STUDYID = rep(1, 10),
    USUBJID = rep(1:2, each = 5),
    PCSPEC = rep("Plasma", 10),
    DRUG = rep("DrugA", 10),
    ANALYTE = rep("Analyte1", 10),
    AFRLT = seq(0, 9),
    AVAL = runif(10)
  )

  # Call format_pkncaconc_data
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT")

  # Test if df_conc is a data frame
  expect_s3_class(df_conc, "data.frame")

  # Test if df_conc has the correct columns
  expect_true(all(c("STUDYID", "USUBJID", "PCSPEC", "DRUG", "ANALYTE",
                    "AFRLT", "AVAL", "conc_groups", "TIME", "IX") %in% colnames(df_conc)))

  # Test if df_conc is correctly grouped and arranged
  expect_equal(df_conc$TIME, df_conc$AFRLT)
  expect_equal(df_conc$IX, rep(1:5, 2))

  # Test if df_conc can be used with PKNCAconc by testing its output
  expect_no_error(
    PKNCA::PKNCAconc(
      df_conc,
      formula = AVAL ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID / ANALYTE,
      exclude_half.life = "exclude_half.life",
      time.nominal = "NFRLT"
    )
  )
})

test_that("format_pkncaconc_data generates correct dataset with multiple doses", {
  # Generate sample ADNCA data with at least two doses per subject
  ADNCA <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1:2, each = 10),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    ANALYTE = rep("Analyte1", 20),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = c(rep(seq(0, 4), 2), rep(seq(0, 4), 2)),
    ROUTE = "intravascular",
    DOSNO = rep(rep(1:2, each = 5), 2),
    AVAL = runif(20)
  )

  # Call format_pkncaconc_data
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE", "DOSNO"),
                                   time_column = "AFRLT")

  # Test if df_conc is a data frame
  expect_s3_class(df_conc, "data.frame")

  # Test if df_conc has the correct columns
  expect_true(all(c("STUDYID", "USUBJID", "PCSPEC",
                    "DRUG", "ANALYTE", "DOSNO",
                    "AFRLT", "AVAL", "conc_groups",
                    "TIME", "IX") %in% colnames(df_conc)))

  # Test if df_conc is correctly grouped and arranged
  expect_equal(df_conc$TIME, df_conc$AFRLT)
  expect_equal(df_conc %>%
                 dplyr::arrange(USUBJID, DOSNO) %>%
                 dplyr::pull(IX),
               rep(1:5, 4))

  # Test if df_conc can be used with PKNCAconc by testing its output
  expect_no_error(
    PKNCA::PKNCAconc(
      df_conc,
      formula = AVAL ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID / ANALYTE,
      exclude_half.life = "exclude_half.life",
      time.nominal = "NFRLT"
    )
  )
})

test_that("format_pkncaconc_data handles empty input", {
  ADNCA <- data.frame()
  expect_error(format_pkncaconc_data(ADNCA,
                                     group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                       "DRUG", "ANALYTE"),
                                     time_column = "AFRLT"),
               regexp = "Input dataframe is empty. Please provide a valid ADNCA dataframe.")
})

test_that("format_pkncaconc_data handles missing columns", {
  ADNCA <- data.frame(
    STUDYID = rep(1, 10),
    USUBJID = rep(1:2, each = 5),
    PCSPEC = rep("Plasma", 10),
    DRUG = rep("DrugA", 10),
    AFRLT = seq(0, 9),
    AVAL = runif(10)
  )
  expect_error(
    format_pkncaconc_data(
      ADNCA,
      group_columns = c("STUDYID", "USUBJID", "PCSPEC", "DRUG", "ANALYTE"),
      time_column = "AFRLT"
    ),
    regexp = "Missing required columns: ANALYTE"
  )
})

test_that("format_pkncaconc_data handles multiple analytes", {
  ADNCA <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1, each = 10),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    ANALYTE = rep(c("Analyte1", "Analyte2"), each = 10),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = rep(seq(0, 9), 2),
    AVAL = runif(20)
  )
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT")
  expect_equal(nrow(df_conc), 20)
  expect_equal(length(unique(df_conc$ANALYTE)), 2)
})

test_that("format_pkncadose_data generates when missing the dose number column", {
  # Generate sample ADNCA data with at least two doses per subject
  ADNCA <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1:2, each = 10),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    ANALYTE = rep("Analyte1", 20),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = rep(seq(0, 4), 4),
    NFRLT = rep(seq(0, 9), 2),
    DOSEA = rep(c(5, 10), each = 10),
    ROUTE = rep(c("intravascular", "extravascular"), each = 10),
    ADOSEDUR = rep(c(0, 0), each = 10),
    AVAL = runif(20)
  )

  # Call format_pkncaconc_data
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT")

  # Call format_pkncadose_data
  df_dose <- format_pkncadose_data(df_conc,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT", since_lastdose_time_column = "ARRLT")

  # Test if df_dose is a data frame
  expect_s3_class(df_dose, "data.frame")

  # Test if df_dose has the correct columns
  expect_true(all(c("STUDYID", "USUBJID", "PCSPEC",
                    "DRUG", "ANALYTE", "AFRLT",
                    "ARRLT", "AVAL", "conc_groups",
                    "TIME", "IX", "ROUTE") %in% colnames(df_dose)))

  # Test if df_dose can be used with PKNCAdose by testing its output
  expect_no_error(
    PKNCA::PKNCAdose(
      data = df_dose,
      formula = DOSEA ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID,
      route = "ROUTE",
      time.nominal = "NFRLT",
      duration = "ADOSEDUR"
    )
  )

  # Test if each subject has at least two doses
  dose_counts <- df_dose %>% group_by(USUBJID) %>% summarise(n = n())
  expect_true(all(dose_counts$n >= 2))
})

test_that("format_pkncadose_data handles empty input", {
  df_conc <- data.frame()
  expect_error(format_pkncadose_data(df_conc,
                                     group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                       "DRUG"),
                                     time_column = "AFRLT",
                                     since_lastdose_time_column = "ARRLT"),
               regexp = "Input dataframe is empty. Please provide a valid concentration dataframe.")
})

test_that("format_pkncadata_intervals handles incorrect input type", {
  mydose <- list(data = data.frame(STUDYID = 1, USUBJID = 1, TIME = 0),
                 columns = list(groups = c("STUDYID", "USUBJID"),
                                time = "TIME"))
  expect_error(format_pkncadata_intervals(mydose),
               regexp = "Input must be a PKNCAdose object from the PKNCA package.")
})

test_that("format_pkncadose_data handles negative time values", {
  df_conc <- data.frame(
    STUDYID = rep(1, 10),
    USUBJID = rep(1:2, each = 5),
    PCSPEC = rep("Plasma", 10),
    DRUG = rep("DrugA", 10),
    ANALYTE = rep("Analyte1", 10),
    AFRLT = c(-1, 0, 1, 2, 3, -1, 0, 1, 2, 3),
    ARRLT = c(-1, 0, 1, 2, 3, -1, 0, 1, 2, 3),
    ROUTE = rep(c("intravascular", "extravascular"), each = 5),
    DOSEA = 10,
    AVAL = runif(10)
  )
  df_dose <- format_pkncadose_data(df_conc,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT",
                                   since_lastdose_time_column = "ARRLT")
  expect_true(all(df_dose$AFRLT >= 0))
})

test_that("format_pkncadose_data handles multiple analytes", {
  df_conc <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1:2, each = 10),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    ANALYTE = rep(rep(c("Analyte1", "Analyte2"), 2), each = 5),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = c(rep(seq(0, 4), 2), rep(seq(5, 9), 2)),
    ROUTE = rep(c("intravascular", "extravascular"), each = 10),
    DOSEA = 10,
    AVAL = runif(20)
  )
  df_dose <- format_pkncadose_data(df_conc,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT",
                                   since_lastdose_time_column = "ARRLT")
  expect_equal(nrow(df_dose), 4)
  expect_equal(length(unique(df_dose$ANALYTE)), 2)
})

test_that("format_pkncadata_intervals generates correct dataset", {
  # Generate sample ADNCA data with at least two doses per subject
  ADNCA <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1:2, each = 10),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    ANALYTE = rep("Analyte1", 20),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = rep(seq(0, 4), 4),
    NFRLT = rep(seq(0, 9), 2),
    ROUTE = "extravascular",
    DOSEA = 10,
    ADOSEDUR = 0,
    AVAL = runif(20)
  )

  # Call format_pkncaconc_data
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT")

  # Call format_pkncadose_data
  df_dose <- format_pkncadose_data(df_conc,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT",
                                   since_lastdose_time_column = "ARRLT")

  # Generate PKNCAconc and PKNCAdose objects
  pknca_conc <- PKNCA::PKNCAconc(
    df_conc,
    formula = AVAL ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID / ANALYTE,
    exclude_half.life = "exclude_half.life",
    time.nominal = "NFRLT"
  )

  pknca_dose <- PKNCA::PKNCAdose(
    data = df_dose,
    formula = DOSEA ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID,
    route = "ROUTE",
    time.nominal = "NFRLT",
    duration = "ADOSEDUR"
  )

  # Define the other arguments for the dose intervals
  params <- c("cmax", "tmax", "half.life", "cl.obs")

  # Call format_pkncadata_intervals
  myintervals <- format_pkncadata_intervals(pknca_conc,
                                            pknca_dose,
                                            params = params,
                                            start_from_last_dose = TRUE)

  # Test if myintervals is a data frame
  expect_s3_class(myintervals, "data.frame")

  # Test if myintervals has the correct columns
  expect_true(all(c("start", "end", "STUDYID",
                    "USUBJID", "type_interval") %in% colnames(myintervals)))

  # Test if interval types are classified as "main"
  expect_true(all(myintervals$type_interval == "main"))

  # Test if myintervals can be used with PKNCAdata by testing its output
  expect_no_error(
    PKNCA::PKNCAdata(
      data.conc = pknca_conc,
      data.dose = pknca_dose,
      intervals = myintervals,
      units = PKNCA::pknca_units_table(
        concu = pknca_conc$data$PCSTRESU[1],
        doseu = pknca_conc$data$DOSEU[1],
        amountu = pknca_conc$data$PCSTRESU[1],
        timeu = pknca_conc$data$RRLTU[1]
      )
    )
  )
})

test_that("format_pkncadata_intervals handles multiple analytes with metabolites", {
  
  # Create mock data with multiple analytes and metabolites
  ADNCA <- data.frame(
    STUDYID = rep(1, 20),
    USUBJID = rep(1, 20),
    PCSPEC = rep("Plasma", 20),
    DRUG = rep("DrugA", 20),
    DOSEA = 10,
    ANALYTE = rep(c("Analyte1", "Metabolite1"), each = 10),
    AFRLT = rep(seq(0, 9), 2),
    ARRLT = rep(seq(0, 4), 4),
    AVAL = c(rep(seq(0, 8, 2),2),
             rep(seq(0, 4), 2))
  )
  
  # Call format_pkncaconc_data
  df_conc <- format_pkncaconc_data(ADNCA,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG", "ANALYTE"),
                                   time_column = "AFRLT")
  
  # Call format_pkncadose_data
  df_dose <- format_pkncadose_data(df_conc,
                                   group_columns = c("STUDYID", "USUBJID", "PCSPEC",
                                                     "DRUG"),
                                   time_column = "AFRLT",
                                   since_lastdose_time_column = "ARRLT")
  
  # Generate PKNCAconc and PKNCAdose objects
  pknca_conc <- PKNCA::PKNCAconc(
    df_conc,
    formula = AVAL ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID / ANALYTE,
    exclude_half.life = "exclude_half.life",
    time.nominal = "NFRLT"
  )
  
  pknca_dose <- PKNCA::PKNCAdose(
    data = df_dose,
    formula = DOSEA ~ TIME | STUDYID + PCSPEC + DRUG + USUBJID
  )
  
  # Define the parameters for the dose intervals
  params <- c("cmax", "tmax", "half.life", "cl.obs")
  
  # Test function
  result <- format_pkncadata_intervals(pknca_conc, pknca_dose, params = params)
  
  expect_equal(as.data.frame(result),
               data.frame(
                 start = c(0, 0, 5, 5),
                 end = c(5, 5, Inf, Inf),
                 STUDYID = c(1, 1, 1, 1),
                 PCSPEC = c("Plasma", "Plasma", "Plasma", "Plasma"),
                 DRUG = c("DrugA", "DrugA", "DrugA", "DrugA"),
                 USUBJID = c(1, 1, 1, 1),
                 ANALYTE = c("Analyte1", "Metabolite1", "Analyte1", "Metabolite1"),
                 cmax = c(TRUE, TRUE, TRUE, TRUE),
                 tmax = c(TRUE, TRUE, TRUE, TRUE),
                 half.life = c(TRUE, TRUE, TRUE, TRUE),
                 cl.obs = c(TRUE, TRUE, TRUE, TRUE),
                 type_interval = c("main", "main", "main", "main")
               )
               )
  
  expect_true(is.data.frame(result))
  expect_true(all(c("start", "end", "STUDYID", "USUBJID", "ANALYTE", "type_interval") %in% colnames(result)))
  expect_true(all(result$type_interval == "main"))
  expect_true(all(result$cmax == TRUE))
  expect_true(all(result$tmax == TRUE))
  expect_true(all(result$half.life == TRUE))
  expect_true(all(result$cl.obs == TRUE))
  
  # Test if result can be used with PKNCAdata by testing its output
  expect_no_error(
    PKNCA::PKNCAdata(
      data.conc = pknca_conc,
      data.dose = pknca_dose,
      intervals = result,
      units = PKNCA::pknca_units_table(
        concu = "ng/mL",
        doseu = "mg",
        amountu = "ng",
        timeu = "h"
      )
    )
  )
})

